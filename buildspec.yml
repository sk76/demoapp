version: 0.2

phases:
  install:
    commands:
      - echo "Install phase started"

  build:
    commands:
      - echo "Packaging backend & frontend"
      - tar -czf backend.tar.gz backend
      - tar -czf frontend.tar.gz frontend

      - echo "Uploading artifacts to S3"
      - aws s3 cp backend.tar.gz s3://$ARTIFACT_BUCKET/
      - aws s3 cp frontend.tar.gz s3://$ARTIFACT_BUCKET/

      - echo "Deploying Backend via SSM"
      - |
        aws ssm send-command \
          --targets "Key=tag:Name,Values=backend-ec2" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "sudo aws s3 cp s3://'$ARTIFACT_BUCKET'/backend.tar.gz /tmp/backend.tar.gz",
            "sudo tar -xzf /tmp/backend.tar.gz -C /var/www/demoapp",
            "cd /var/www/demoapp/backend",
            "sudo npm install",
            "sudo systemctl restart demoapp"
          ]'

      - echo "Deploying Frontend via SSM"
      - |
        aws ssm send-command \
          --targets "Key=tag:Name,Values=frontend-ec2" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "sudo aws s3 cp s3://'$ARTIFACT_BUCKET'/frontend.tar.gz /tmp/frontend.tar.gz",
            "sudo tar -xzf /tmp/frontend.tar.gz -C /usr/share/nginx/html --strip-components=1",
            "sudo systemctl reload nginx"
          ]'
